!function($,e,t,r){"use strict";$.api=$.fn.api=function(t){var n=$($.isFunction(this)?e:this),o=n.selector||"",s=(new Date).getTime(),a=[],i=arguments[0],u="string"==typeof i,c=[].slice.call(arguments,1),d;return n.each(function(){var n=$.isPlainObject(t)?$.extend(!0,{},$.fn.api.settings,t):$.extend({},$.fn.api.settings),l=n.namespace,g=n.metadata,f=n.selector,p=n.error,m=n.className,b="."+l,v="module-"+l,h=$(this),y=h.closest(f.form),q=n.stateContext?$(n.stateContext):h,R,x,A,T,S,k=this,j=q[0],P=h.data(v),w;w={initialize:function(){u||w.bind.events(),w.instantiate()},instantiate:function(){w.verbose("Storing instance of module",w),P=w,h.data(v,P)},destroy:function(){w.verbose("Destroying previous module for",k),h.removeData(v).off(b)},bind:{events:function(){var e=w.get.event();e?(w.verbose("Attaching API events to element",e),h.on(e+b,w.event.trigger)):"now"==n.on&&(w.debug("Querying API endpoint immediately"),w.query())}},decode:{json:function(e){if(e!==r&&"string"==typeof e)try{e=JSON.parse(e)}catch(t){}return e}},read:{cachedResponse:function(t){var n;return e.Storage===r?void w.error(p.noStorage):(n=sessionStorage.getItem(t),w.debug("Using cached response",t,n),n=w.decode.json(n),!1)}},write:{cachedResponse:function(t,n){return n&&""===n?void w.debug("Response empty, not caching",n):e.Storage===r?void w.error(p.noStorage):($.isPlainObject(n)&&(n=JSON.stringify(n)),sessionStorage.setItem(t,n),void w.verbose("Storing cached response for url",t,n))}},query:function(){if(w.is.disabled())return void w.debug("Element is disabled API request aborted");if(w.is.loading()){if(!n.interruptRequests)return void w.debug("Cancelling request, previous request is still pending");w.debug("Interrupting previous request"),w.abort()}return n.defaultData&&$.extend(!0,n.urlData,w.get.defaultData()),n.serializeForm&&(n.data=w.add.formData(n.data)),x=w.get.settings(),x===!1?(w.cancelled=!0,void w.error(p.beforeSend)):(w.cancelled=!1,A=w.get.templatedURL(),A||w.is.mocked()?(A=w.add.urlData(A),A||w.is.mocked()?(x.url=n.base+A,R=$.extend(!0,{},n,{type:n.method||n.type,data:T,url:n.base+A,beforeSend:n.beforeXHR,success:function(){},failure:function(){},complete:function(){}}),w.debug("Querying URL",R.url),w.verbose("Using AJAX settings",R),"local"===n.cache&&w.read.cachedResponse(A)?(w.debug("Response returned from local cache"),w.request=w.create.request(),void w.request.resolveWith(j,[w.read.cachedResponse(A)])):void(n.throttle?n.throttleFirstRequest||w.timer?(w.debug("Throttling request",n.throttle),clearTimeout(w.timer),w.timer=setTimeout(function(){w.timer&&delete w.timer,w.debug("Sending throttled request",T,R.method),w.send.request()},n.throttle)):(w.debug("Sending request",T,R.method),w.send.request(),w.timer=setTimeout(function(){},n.throttle)):(w.debug("Sending request",T,R.method),w.send.request()))):void 0):void w.error(p.missingURL))},should:{removeError:function(){return n.hideError===!0||"auto"===n.hideError&&!w.is.form()}},is:{disabled:function(){return h.filter(f.disabled).length>0},form:function(){return h.is("form")||q.is("form")},mocked:function(){return n.mockResponse||n.mockResponseAsync||n.response||n.responseAsync},input:function(){return h.is("input")},loading:function(){return w.request&&"pending"==w.request.state()},abortedRequest:function(e){return e&&e.readyState!==r&&0===e.readyState?(w.verbose("XHR request determined to be aborted"),!0):(w.verbose("XHR request was not aborted"),!1)},validResponse:function(e){return"json"!==n.dataType&&"jsonp"!==n.dataType||!$.isFunction(n.successTest)?(w.verbose("Response is not JSON, skipping validation",n.successTest,e),!0):(w.debug("Checking JSON returned success",n.successTest,e),n.successTest(e)?(w.debug("Response passed success test",e),!0):(w.debug("Response failed success test",e),!1))}},was:{cancelled:function(){return w.cancelled||!1},succesful:function(){return w.request&&"resolved"==w.request.state()},failure:function(){return w.request&&"rejected"==w.request.state()},complete:function(){return w.request&&("resolved"==w.request.state()||"rejected"==w.request.state())}},add:{urlData:function(e,t){var o,s;return e&&(o=e.match(n.regExp.required),s=e.match(n.regExp.optional),t=t||n.urlData,o&&(w.debug("Looking for required URL variables",o),$.each(o,function(o,s){var a=-1!==s.indexOf("$")?s.substr(2,s.length-3):s.substr(1,s.length-2),i=$.isPlainObject(t)&&t[a]!==r?t[a]:h.data(a)!==r?h.data(a):q.data(a)!==r?q.data(a):t[a];return i===r?(w.error(p.requiredParameter,a,e),e=!1,!1):(w.verbose("Found required variable",a,i),i=n.encodeParameters?w.get.urlEncodedValue(i):i,e=e.replace(s,i),void 0)})),s&&(w.debug("Looking for optional URL variables",o),$.each(s,function(n,o){var s=-1!==o.indexOf("$")?o.substr(3,o.length-4):o.substr(2,o.length-3),a=$.isPlainObject(t)&&t[s]!==r?t[s]:h.data(s)!==r?h.data(s):q.data(s)!==r?q.data(s):t[s];a!==r?(w.verbose("Optional variable Found",s,a),e=e.replace(o,a)):(w.verbose("Optional variable not found",s),e=-1!==e.indexOf("/"+o)?e.replace("/"+o,""):e.replace(o,""))}))),e},formData:function(e){var t=$.fn.serializeObject!==r,o=t?y.serializeObject():y.serialize(),s;return e=e||n.data,s=$.isPlainObject(e),s?t?(w.debug("Extending existing data with form data",e,o),e=$.extend(!0,{},e,o)):(w.error(p.missingSerialize),w.debug("Cant extend data. Replacing data with form data",e,o),e=o):(w.debug("Adding form data",o),e=o),e}},send:{request:function(){w.set.loading(),w.request=w.create.request(),w.is.mocked()?w.mockedXHR=w.create.mockedXHR():w.xhr=w.create.xhr(),n.onRequest.call(j,w.request,w.xhr)}},event:{trigger:function(e){w.query(),"submit"!=e.type&&"click"!=e.type||e.preventDefault()},xhr:{always:function(){},done:function(e,t,r){var o=this,s=(new Date).getTime()-S,a=n.loadingDuration-s,i=$.isFunction(n.onResponse)?n.onResponse.call(o,$.extend(!0,{},e)):!1;a=a>0?a:0,i&&(w.debug("Modified API response in onResponse callback",n.onResponse,i,e),e=i),a>0&&w.debug("Response completed early delaying state change by",a),setTimeout(function(){w.is.validResponse(e)?w.request.resolveWith(o,[e,r]):w.request.rejectWith(o,[r,"invalid"])},a)},fail:function(e,t,r){var o=this,s=(new Date).getTime()-S,a=n.loadingDuration-s;a=a>0?a:0,a>0&&w.debug("Response completed early delaying state change by",a),setTimeout(function(){w.is.abortedRequest(e)?w.request.rejectWith(o,[e,"aborted",r]):w.request.rejectWith(o,[e,"error",t,r])},a)}},request:{done:function(e,t){w.debug("Successful API Response",e),"local"===n.cache&&A&&(w.write.cachedResponse(A,e),w.debug("Saving server response locally",w.cache)),n.onSuccess.call(j,e,h,t)},complete:function(e,t){var r,o;w.was.succesful()?(o=e,r=t):(r=e,o=w.get.responseFromXHR(r)),w.remove.loading(),n.onComplete.call(j,o,h,r)},fail:function(e,t,o){var s=w.get.responseFromXHR(e),a=w.get.errorFromRequest(s,t,o);"aborted"==t?(w.debug("XHR Aborted (Most likely caused by page navigation or CORS Policy)",t,o),n.onAbort.call(j,t,h,e)):"invalid"==t?w.debug("JSON did not pass success test. A server-side error has most likely occurred",s):"error"==t&&e!==r&&(w.debug("XHR produced a server error",t,o),200!=e.status&&o!==r&&""!==o&&w.error(p.statusMessage+o,R.url),n.onError.call(j,a,h,e)),n.errorDuration&&"aborted"!==t&&(w.debug("Adding error state"),w.set.error(),w.should.removeError()&&setTimeout(w.remove.error,n.errorDuration)),w.debug("API Request failed",a,e),n.onFailure.call(j,s,h,e)}}},create:{request:function(){return $.Deferred().always(w.event.request.complete).done(w.event.request.done).fail(w.event.request.fail)},mockedXHR:function(){var e=!1,t=!1,r=!1,o=n.mockResponse||n.response,s=n.mockResponseAsync||n.responseAsync,a,i,u;return u=$.Deferred().always(w.event.xhr.complete).done(w.event.xhr.done).fail(w.event.xhr.fail),o?($.isFunction(o)?(w.debug("Using specified synchronous callback",o),i=o.call(j,x)):(w.debug("Using settings specified response",o),i=o),u.resolveWith(j,[i,e,{responseText:i}])):$.isFunction(s)&&(a=function(n){w.debug("Async callback returned response",n),n?u.resolveWith(j,[n,e,{responseText:n}]):u.rejectWith(j,[{responseText:n},t,r])},w.debug("Using specified async response callback",s),s.call(j,x,a)),u},xhr:function(){var e;return e=$.ajax(R).always(w.event.xhr.always).done(w.event.xhr.done).fail(w.event.xhr.fail),w.verbose("Created server request",e),e}},set:{error:function(){w.verbose("Adding error state to element",q),q.addClass(m.error)},loading:function(){w.verbose("Adding loading state to element",q),q.addClass(m.loading),S=(new Date).getTime()}},remove:{error:function(){w.verbose("Removing error state from element",q),q.removeClass(m.error)},loading:function(){w.verbose("Removing loading state from element",q),q.removeClass(m.loading)}},get:{responseFromXHR:function(e){return $.isPlainObject(e)?"json"==n.dataType||"jsonp"==n.dataType?w.decode.json(e.responseText):e.responseText:!1},errorFromRequest:function(e,t,o){return $.isPlainObject(e)&&e.error!==r?e.error:n.error[t]!==r?n.error[t]:o},request:function(){return w.request||!1},xhr:function(){return w.xhr||!1},settings:function(){var e;return e=n.beforeSend.call(j,n),e&&(e.success!==r&&(w.debug("Legacy success callback detected",e),w.error(p.legacyParameters,e.success),e.onSuccess=e.success),e.failure!==r&&(w.debug("Legacy failure callback detected",e),w.error(p.legacyParameters,e.failure),e.onFailure=e.failure),e.complete!==r&&(w.debug("Legacy complete callback detected",e),w.error(p.legacyParameters,e.complete),e.onComplete=e.complete)),e===r&&w.error(p.noReturnedValue),e!==r?$.extend(!0,{},e):$.extend(!0,{},n)},urlEncodedValue:function(t){var r=e.decodeURIComponent(t),n=e.encodeURIComponent(t),o=r!==t;return o?(w.debug("URL value is already encoded, avoiding double encoding",t),t):(w.verbose("Encoding value using encodeURIComponent",t,n),n)},defaultData:function(){var e={};return $.isWindow(k)||(w.is.input()?e.value=h.val():w.is.form()&&(e.text=h.text())),e},event:function(){return $.isWindow(k)||"now"==n.on?(w.debug("API called without element, no events attached"),!1):"auto"==n.on?h.is("input")?k.oninput!==r?"input":k.onpropertychange!==r?"propertychange":"keyup":h.is("form")?"submit":"click":n.on},templatedURL:function(e){if(e=e||h.data(g.action)||n.action||!1,A=h.data(g.url)||n.url||!1)return w.debug("Using specified url",A),A;if(e){if(w.debug("Looking up url for action",e,n.api),n.api[e]===r&&!w.is.mocked())return void w.error(p.missingAction,n.action,n.api);A=n.api[e]}else w.is.form()&&(A=h.attr("action")||q.attr("action")||!1,w.debug("No url or action specified, defaulting to form action",A));return A}},abort:function(){var e=w.get.xhr();e&&"resolved"!==e.state()&&(w.debug("Cancelling API request"),e.abort())},reset:function(){w.remove.error(),w.remove.loading()},setting:function(e,t){if(w.debug("Changing setting",e,t),$.isPlainObject(e))$.extend(!0,n,e);else{if(t===r)return n[e];n[e]=t}},internal:function(e,t){if($.isPlainObject(e))$.extend(!0,w,e);else{if(t===r)return w[e];w[e]=t}},debug:function(){n.debug&&(n.performance?w.performance.log(arguments):(w.debug=Function.prototype.bind.call(console.info,console,n.name+":"),w.debug.apply(console,arguments)))},verbose:function(){n.verbose&&n.debug&&(n.performance?w.performance.log(arguments):(w.verbose=Function.prototype.bind.call(console.info,console,n.name+":"),w.verbose.apply(console,arguments)))},error:function(){w.error=Function.prototype.bind.call(console.error,console,n.name+":"),w.error.apply(console,arguments)},performance:{log:function(e){var t,r,o;n.performance&&(t=(new Date).getTime(),o=s||t,r=t-o,s=t,a.push({Name:e[0],Arguments:[].slice.call(e,1)||"","Execution Time":r})),clearTimeout(w.performance.timer),w.performance.timer=setTimeout(w.performance.display,500)},display:function(){var e=n.name+":",t=0;s=!1,clearTimeout(w.performance.timer),$.each(a,function(e,r){t+=r["Execution Time"]}),e+=" "+t+"ms",o&&(e+=" '"+o+"'"),(console.group!==r||console.table!==r)&&a.length>0&&(console.groupCollapsed(e),console.table?console.table(a):$.each(a,function(e,t){console.log(t.Name+": "+t["Execution Time"]+"ms")}),console.groupEnd()),a=[]}},invoke:function(e,t,n){var o=P,s,a,i;return t=t||c,n=k||n,"string"==typeof e&&o!==r&&(e=e.split(/[\. ]/),s=e.length-1,$.each(e,function(t,n){var i=t!=s?n+e[t+1].charAt(0).toUpperCase()+e[t+1].slice(1):e;if($.isPlainObject(o[i])&&t!=s)o=o[i];else{if(o[i]!==r)return a=o[i],!1;if(!$.isPlainObject(o[n])||t==s)return o[n]!==r?(a=o[n],!1):(w.error(p.method,e),!1);o=o[n]}})),$.isFunction(a)?i=a.apply(n,t):a!==r&&(i=a),$.isArray(d)?d.push(i):d!==r?d=[d,i]:i!==r&&(d=i),a}},u?(P===r&&w.initialize(),w.invoke(i)):(P!==r&&P.invoke("destroy"),w.initialize())}),d!==r?d:this},$.api.settings={name:"API",namespace:"api",debug:!1,verbose:!1,performance:!0,api:{},cache:!0,interruptRequests:!0,on:"auto",stateContext:!1,loadingDuration:0,hideError:"auto",errorDuration:2e3,encodeParameters:!0,action:!1,url:!1,base:"",urlData:{},defaultData:!0,serializeForm:!1,throttle:0,throttleFirstRequest:!0,method:"get",data:{},dataType:"json",mockResponse:!1,mockResponseAsync:!1,response:!1,responseAsync:!1,beforeSend:function(e){return e},beforeXHR:function(e){},onRequest:function(e,t){},onResponse:!1,onSuccess:function(e,t){},onComplete:function(e,t){},onFailure:function(e,t){},onError:function(e,t){},onAbort:function(e,t){},successTest:!1,error:{beforeSend:"The before send function has aborted the request",error:"There was an error with your request",exitConditions:"API Request Aborted. Exit conditions met",JSONParse:"JSON could not be parsed during error handling",legacyParameters:"You are using legacy API success callback names",method:"The method you called is not defined",missingAction:"API action used but no url was defined",missingSerialize:"jquery-serialize-object is required to add form data to an existing data object",missingURL:"No URL specified for api event",noReturnedValue:"The beforeSend callback must return a settings object, beforeSend ignored.",noStorage:"Caching responses locally requires session storage",parseError:"There was an error parsing your request",requiredParameter:"Missing a required URL parameter: ",statusMessage:"Server gave an error: ",timeout:"Your request timed out"},regExp:{required:/\{\$*[A-z0-9]+\}/g,optional:/\{\/\$*[A-z0-9]+\}/g},className:{loading:"loading",error:"error"},selector:{disabled:".disabled",form:"form"},metadata:{action:"action",url:"url"}}}(jQuery,window,document);